#!/bin/bash
# Download and build graph processing systems.
USAGE="./configure [--prefix /path/to/install (default: $HOME/epg)]"

## Dependencies:
### Spack
#### Python 2.6 or 2.7, a C/C++ Compiler, git, and curl
### GraphMat
#### GCC, MPICH, libboost_serialization (Automatically downloaded)
OLDWD=$(pwd)
if [ "$1" = "-h" -o "$1" = "--help" ]; then
	echo $USAGE
	exit 0
elif [ -z $1 ]; then
	PREFIX="$HOME/epg"
else
	PREFIX="$1"
fi
echo "Downloading packages in $PREFIX"

if [ -z "$SPACK_ROOT" ]; then
	echo You must download spack and set the SPACK_ROOT environment variable
	echo -e "This can be done using\n"
	echo "export SPACK_ROOT=$HOME/spack"
	echo "git clone https://github.com/LLNL/spack.git $SPACK_ROOT"
	echo -e "\nsetting SPACK_ROOT as you wish"
	exit 2
fi
# This adds spack to PATH and enables environment modules
# You might also consider doing this in your own shell
if [ -n $SPACK_ROOT ]; then
	. $SPACK_ROOT/share/spack/setup-env.sh
fi

# GraphMat
# Use spack's default gcc (which may not be your regular gcc)
CXX_COMPILER_SPEC=$(spack compilers | grep ^gcc | head -n 1)
CXX_COMPILER=$(spack compiler info $CXX_COMPILER_SPEC | awk '/cxx/{print $3}')
spack install boost@1.63.0%$CXX_COMPILER_SPEC
spack install mpich@3.2%$CXX_COMPILER_SPEC
spack load boost@1.63.0%$CXX_COMPILER_SPEC
spack load mpich@3.2%$CXX_COMPILER_SPEC
git clone https://github.com/narayanan2004/GraphMat.git "$PREFIX/GraphMat"
cd "$PREFIX/GraphMat"
make MPICXX="mpic++ -cxx=$CXX_COMPILER" CXX="$CXX_COMPILER"

cd "$OLDWD"

